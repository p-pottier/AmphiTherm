---
title: "Data_curation"
author: "Patrice Pottier"
date: "latest update: `r format(Sys.time(), '%d %B %Y')`"
output: rmdformats::readthedown
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
# knitr setting
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE, 
  tidy = TRUE,
  cache = TRUE
)
```


# **Load packages and data**

## *Load packages* 

```{r}
pacman::p_load(tidyverse,
               maps,
               ape,
               patchwork,
               ggtree, # devtools::install_github("YuLab-SMU/ggtree")
               ggtreeExtra, # devtools::install_github("xiangpin/ggtreeExtra")
               ggnewscale, # this package is necessary for building trees
               here,
               ggspatial, 
               raster,
               rasterSp) 
```

## *Load data and phylogenetic tree*

This tree is the consensus tree from Pyron and Jetz (2018)

```{r}
d.raw<-read_csv("data/Raw_Tpref_CTmin_data.csv") # Load extracted data
tree<-read.tree("data/Consensus_tree_Jetz_Pyron_2018.tre") # Load tree
tree_sp_info <- read_csv("data/Metadata_Jetz_Pyron_2018.csv") # Load taxonomic information
```


# **Harmonise taxonomy**

`10 species` are not included in the tree of Pyron and Jetz (2018): 
- *Amazophrynella javierbustamantei* 
- *Buergeria choui* 
- *Chiasmocleis royi* 
- *Dendropsophus kamagarini* 
- *Gastrotheca lojana* 
- *Microkayla quimsacruzis* 
- *Pristimantis macrummendozai* 
- *Scinax tsachila* 
- *Sclerophrys gutturalis* 
- *Zhangixalus prasinatus*
Those species were not removed from the curated data.

`4 species` were not described at the species level: 
- *Aplastodiscus sp.*  
- *Crossodactylus sp.* 
- *Engystomops sp.*
- *Hyloscirtus sp.*
Those species were removed from the curated data.

and `18 species` names were up to date with amphibiaweb.org, but did not match the phylogeny of Jetz and Pyron (2018). 
Taxonomic names were found, and we replaced species names to match the phylogeny of Jetz and Pyron (see below)


```{r}
d.treecheck <- dplyr::select(d.raw, family, species) # Only select relevant variables
d.treecheck$species <- gsub(" ", "_", d.treecheck$species) # Add underscore between species names

'%!in%' <- function(x,y)!('%in%'(x,y)) # Function opposite of %in%

d.not_in_tree<-d.treecheck[d.treecheck$species %!in% tree$tip.label, ] # Find species not matching the tree
d.not_in_tree <- unique(d.not_in_tree)

species_tree<-as.data.frame(tree$tip.label) # To check species in the tree
species<-as.data.frame(d.raw$species) # To check species in the raw data

# Replace species names not matching the tree
d <- d.raw
d$species[d$species =="Agalychnis dacnicolor"] <- "Pachymedusa dacnicolor" # Rename species to match phylogeny
d$species[d$species =="Boana albomarginata"] <- "Hypsiboas albomarginatus" 
d$species[d$species =="Boana albopunctata"] <- "Hypsiboas albopunctatus" 
d$species[d$species =="Boana almendarizae"] <- "Hypsiboas almendarizae" 
d$species[d$species =="Boana cinerascens"] <- "Hypsiboas cinerascens" 
d$species[d$species =="Boana faber"] <- "Hypsiboas faber" 
d$species[d$species =="Boana geographica"] <- "Hypsiboas geographicus" 
d$species[d$species =="Boana lanciformis"] <- "Hypsiboas lanciformis" 
d$species[d$species =="Boana pellucens"] <- "Hypsiboas pellucens" 
d$species[d$species =="Boana pulchella"] <- "Hypsiboas pulchellus" 
d$species[d$species =="Boana rosenbergi"] <- "Hypsiboas rosenbergi" 
d$species[d$species =="Cophixalus macdonaldi"] <- "Cophixalus mcdonaldi" 
d$species[d$species =="Desmognathus amphileucus"] <- "Desmognathus quadramaculatus" 
d$species[d$species =="Hyla crucifer"] <- "Pseudacris crucifer" 
d$species[d$species =="Nidirana adenopleura"] <- "Babina adenopleura" 
d$species[d$species =="Pithecopus rohdei"] <- "Phyllomedusa rohdei" 
d$species[d$species =="Pristimantis wnigrum"] <- "Pristimantis w-nigrum" 
d$species[d$species =="Rhinella parachnemis"] <- "Rhinella diptycha" 

d.treecheck <- dplyr::select(d, family, species) # Only select relevant variables
d.treecheck$species <- gsub(" ", "_", d.treecheck$species) # Add underscore between species names
d.not_in_tree<-d.treecheck[d.treecheck$species %!in% tree$tip.label, ] # Check again
d.not_in_tree <- unique(d.not_in_tree) # All good.

```

# **Data checking** 

```{r}
summary(d)

summary(d$latitude)
summary(d$longitude)

summary(d$body_mass) 
summary(d$pH) 

summary(d$mean_trait)
summary(d$error_trait)
summary(d$n_trait)


table(d$origin, useNA="ifany")
table(d$month_sampling, useNA="ifany")
table(d$acclimated, useNA="ifany") 

table(d$life_stage_acclimated, useNA="ifany")
table(d$gosner_acclimated, useNA="ifany") 

table(d$life_stage_tested, useNA="ifany")
table(d$gosner_tested, useNA="ifany") 

table(d$sex, useNA="ifany") 
table(d$endpoint, useNA="ifany") 
table(d$metric, useNA="ifany") 
table(d$error_type, useNA="ifany") 
```

# **Add species information and harmonise data with CTmax database**

Here we do some further processing to have similar column structures and values between this dataset, and the one published in Pottier et al., 2022 (Scientific Data).

# *Load CTmax database*
```{r}
CTmax_database <- read_csv("data/Raw_CTmax_data.csv")

# Standardise species names
CTmax_database$species[CTmax_database$species =="Agalychnis dacnicolor"] <- "Pachymedusa dacnicolor"
CTmax_database$species[CTmax_database$species =="Anaxyrus caronus"] <- "Anaxyrus canorus"
CTmax_database$species[CTmax_database$species =="Boana albomargina"] <- "Hypsiboas albomarginatus"
CTmax_database$species[CTmax_database$species =="Boana albopunctata"] <- "Hypsiboas albopunctatus"
CTmax_database$species[CTmax_database$species =="Boana almendarizae"] <- "Hypsiboas almendarizae"
CTmax_database$species[CTmax_database$species =="Boana boans"] <- "Hypsiboas boans"
CTmax_database$species[CTmax_database$species =="Boana cinerascens"] <- "Hypsiboas cinerascens"
CTmax_database$species[CTmax_database$species =="Boana crepitans"] <- "Hypsiboas crepitans"
CTmax_database$species[CTmax_database$species =="Boana curupi"] <- "Hypsiboas curupi"
CTmax_database$species[CTmax_database$species =="Boana faber"] <- "Hypsiboas faber"
CTmax_database$species[CTmax_database$species =="Boana fasciata"] <- "Hypsiboas fasciatus"
CTmax_database$species[CTmax_database$species =="Boana geographica"] <- "Hypsiboas geographicus"
CTmax_database$species[CTmax_database$species =="Boana lanciformis"] <- "Hypsiboas lanciformis"
CTmax_database$species[CTmax_database$species =="Boana pardalis"] <- "Hypsiboas pardalis"
CTmax_database$species[CTmax_database$species =="Boana pellucens"] <- "Hypsiboas pellucens"
CTmax_database$species[CTmax_database$species =="Boana pulchella"] <- "Hypsiboas pulchellus"
CTmax_database$species[CTmax_database$species =="Boana punctata"] <- "Hypsiboas punctatus"
CTmax_database$species[CTmax_database$species =="Boana raniceps"] <- "Hypsiboas raniceps"
CTmax_database$species[CTmax_database$species =="Boana rosenbergi"] <- "Hypsiboas rosenbergi"
CTmax_database$species[CTmax_database$species =="Boana rufitela"] <- "Hypsiboas rutifelus"
CTmax_database$species[CTmax_database$species =="Boana semilineata"] <- "Hypsiboas semilineatus"
CTmax_database$species[CTmax_database$species =="Chalcorana labialis"] <- "Hylarana labialis"
CTmax_database$species[CTmax_database$species =="Chiasmocleis bassleri"] <- "Syncope bassleri"
CTmax_database$species[CTmax_database$species =="Hyalinobatrachium fleischmann"] <- "Hyalinobatrachium fleischmanni"
CTmax_database$species[CTmax_database$species =="Hyla crucifer"] <- "Pseudacris crucifer"
CTmax_database$species[CTmax_database$species =="Hyloxalus jacobuspetersi"] <- "Colostethus jacobuspetersi"
CTmax_database$species[CTmax_database$species =="Hynobius fucus"] <- "Hynobius fuca"
CTmax_database$species[CTmax_database$species =="Lithobates sphenocephalus"] <- "Rana sphenocephala"
CTmax_database$species[CTmax_database$species =="Neobatrachus sudellae"] <- "Neobatrachus sudelli"
CTmax_database$species[CTmax_database$species =="Nidirana adenopleura"] <- "Babina adenopleura"
CTmax_database$species[CTmax_database$species =="Phrynoglossus laevis"] <- "Occidozyga laevis"
CTmax_database$species[CTmax_database$species =="Physalaemus nattereri"] <- "Eupemphix nattereri"
CTmax_database$species[CTmax_database$species =="Pseudis platentis"] <- "Pseudis platensis"
CTmax_database$species[CTmax_database$species =="Rana perezi"] <- "Pelophylax perezi"
CTmax_database$species[CTmax_database$species =="Scinax elaeochrous"] <- "Scinax elaeochroa"

# Correct some typologies
CTmax_database %>%
     group_by(species) %>%
     summarise(family  = unique(family)) %>%
     filter(n()>1)

CTmax_database$family[CTmax_database$species =="Eleutherodactylus coqui"] <- "Eleutherodactylidae"
CTmax_database$family[CTmax_database$species =="Mixophyes fasciolatus"] <- "Myobatrachidae"
CTmax_database$family[CTmax_database$species =="Pelodytes ibericus"] <- "Pelodytidae"
CTmax_database$family[CTmax_database$species =="Pelodytes punctatus"] <- "Pelodytidae"
CTmax_database$family[CTmax_database$species =="Pelophylax perezi"] <- "Ranidae"
```

# *Add IUCN threat status* 
```{r}
# Take IUCN data from previous databse
IUCN_data <- dplyr::select(CTmax_database, 
                           order, 
                           species,
                           IUCN_status)
IUCN_data <- IUCN_data[IUCN_data$species %in% d$species,]
IUCN_data <- distinct(IUCN_data)

# Join with the rest of the data
d <- left_join(d, IUCN_data, by = "species")

# Manually add IUCN data from species not matching the IUCN list
d.not_matching <- filter(d, is.na(IUCN_status)==TRUE)
unique(d.not_matching$species)

d$IUCN_status[d$species=="Rana sylvatica"] <- "LC"
d$IUCN_status[d$species=="Rana onca"] <- "EN"
d$IUCN_status[d$species=="Rana catesbeiana"] <- "LC"
d$IUCN_status[d$species=="Hylomantis aspera"] <- "LC"
d$IUCN_status[d$species=="Phyllomedusa rohdei"] <- "LC"
d$IUCN_status[d$species=="Scinax strigilatus"] <- "LC"
d$IUCN_status[d$species=="Microkayla quimsacruzis"] <- "EN"
d$IUCN_status[d$species=="Cynops orientalis"] <- "LC"
d$IUCN_status[d$species=="Epipedobates darwinwallacei"] <- "EN"
d$IUCN_status[d$species=="Hypsiboas almendarizae"] <- "NT"
d$IUCN_status[d$species=="Gastrotheca lojana"] <- "VU"
d$IUCN_status[d$species=="Scinax tsachila"] <- "LC"
d$IUCN_status[d$species=="Pristimantis macrummendozai"] <- "DD"
d$IUCN_status[d$species=="Plethodon chlorobryonis"] <- "LC"
d$IUCN_status[d$species=="Plethodon variolatus"] <- "LC"
d$IUCN_status[d$species=="Plethodon ocmulgee"] <- "LC"
d$IUCN_status[d$species=="Plethodon grobmani"] <- "LC"
d$IUCN_status[d$species=="Hyla squirella"] <- "LC"
d$IUCN_status[d$species=="Hyla chrysoscelis"] <- "LC"
d$IUCN_status[d$species=="Hyla versicolor"] <- "LC"
d$IUCN_status[d$species=="Hyla cinerea"] <- "LC"
d$IUCN_status[d$species=="Hyla gratiosa"] <- "LC"
d$IUCN_status[d$species=="Pristimantis matidiktyo"] <- "LC"
d$IUCN_status[d$species=="Pristimantis bicantus"] <- "VU"
d$IUCN_status[d$species=="Cophixalus australis"] <- "LC"
d$IUCN_status[d$species=="Pristimantis pharangobates"] <- "LC"
d$IUCN_status[d$species=="Pristimantis reichlei"] <- "LC"
d$IUCN_status[d$species=="Amazophrynella javierbustamantei"] <- "LC"
d$IUCN_status[d$species=="Chiasmocleis royi"] <- "LC"
d$IUCN_status[d$species=="Dendropsophus kamagarini"] <- "LC"
d$IUCN_status[d$species=="Elachistocleis muiraquitan"] <- "LC"
d$IUCN_status[d$species=="Hyloxalus yasuni"] <- "LC"
d$IUCN_status[d$species=="Hyla japonica"] <- "LC"
d$IUCN_status[d$species=="Rana pipiens"] <- "LC"
d$IUCN_status[d$species=="Rana palmipes"] <- "LC"
d$IUCN_status[d$species=="Rana warszewitschii"] <- "LC"
d$IUCN_status[d$species=="Pachymedusa dacnicolor"] <- "LC"
d$IUCN_status[d$species=="Gastrophryne mazatlanensis"] <- "LC"
d$IUCN_status[d$species=="Pelophylax esculentus"] <- "LC"
d$IUCN_status[d$species=="Rana septentrionalis"] <- "LC"
d$IUCN_status[d$species=="Rana palustris"] <- "LC"
d$IUCN_status[d$species=="Cyclorana australis"] <- "LC"
d$IUCN_status[d$species=="Buergeria choui"] <- "LC"
d$IUCN_status[d$species=="Zhangixalus prasinatus"] <- "NT"
d$IUCN_status[d$species=="Polypedates braueri"] <- "LC"
d$IUCN_status[d$species=="Bolitoglossa ramosi"] <- "NT"
d$IUCN_status[d$species=="Triturus carnifex"] <- "VU"
d$IUCN_status[d$species=="Ichthyosaura alpestris"] <- "LC"
d$IUCN_status[d$species=="Charadrahyla nephila"] <- "EN"
d$IUCN_status[d$species=="Nanorana pleskei"] <- "LC"
d$IUCN_status[d$species=="Lissotriton helveticus"] <- "LC"
d$IUCN_status[d$species=="Lissotriton montandoni"] <- "LC"
d$IUCN_status[d$species=="Lissotriton vulgaris"] <- "LC"
d$IUCN_status[d$species=="Triturus karelinii"] <- "LC"
d$IUCN_status[d$species=="Lyciasalamandra helverseni"] <- "VU"
d$IUCN_status[d$species=="Plethodon albagula"] <- "LC"
d$IUCN_status[d$species=="Plethodon angusticlavius"] <- "LC"
d$IUCN_status[d$species=="Calotriton asper"] <- "LC"
d$IUCN_status[d$species=="Sclerophrys gutturalis"] <- "LC"
d$IUCN_status[d$species=="Atelopus zeteki"] <- "CR"
d$IUCN_status[d$species=="Ambystoma texanum"] <- "LC"
d$IUCN_status[d$species=="Pristimantis crucifer"] <- "NT"
d$IUCN_status[d$species=="Pristimantis parvillus"] <- "VU"
d$IUCN_status[d$species=="Rhinella jimi"] <- "LC"
d$IUCN_status[d$species=="Desmognathus santeetlah"] <- "NT"
d$IUCN_status[d$species=="Plethodon sherando"] <- "VU"
d$IUCN_status[d$species=="Dendropsophus pauiniensis"] <- "DD"
d$IUCN_status[d$species=="Incilius valliceps"] <- "LC"
d$IUCN_status[d$species=="Anaxyrus debilis"] <- "LC"
d$IUCN_status[d$species=="Incilius luetkenii"] <- "LC"
d$IUCN_status[d$species=="Incilius coccifer"] <- "LC"
d$IUCN_status[d$species=="Scinax staufferi"] <- "LC"
d$IUCN_status[d$species=="Craugastor fleischmanni"] <- "CR"
d$IUCN_status[d$species=="Eurycea cirrigera"] <- "LC"
d$IUCN_status[d$species=="Eurycea wilderae"] <- "LC"
d$IUCN_status[d$species=="Leiopelma hochstetteri"] <- "LC"

d.not_matching <- filter(d, is.na(IUCN_status)==TRUE)
unique(d.not_matching$species) # All good. The ones left were not identified at the species level

# Add missing orders
d %>% group_by(family) %>% summarise(n = n_distinct(order)) %>% filter(n>1)
d$order[d$family == "Rhacophoridae"] <- "Anura"
d$order[d$family == "Hylidae"] <- "Anura"
d$order[d$family == "Ranidae"] <- "Anura"
d$order[d$family == "Microhylidae"] <- "Anura"
d$order[d$family == "Dendrobatidae"] <- "Anura"
d$order[d$family == "Salamandridae"] <- "Caudata"
d$order[d$family == "Strabomantidae"] <- "Anura"
d$order[d$family == "Plethodontidae"] <- "Caudata"
d$order[d$family == "Hemiphractidae"] <- "Anura"
d$order[d$family == "Bufonidae"] <- "Anura"
d$order[d$family == "Bufonidae"] <- "Anura"
d$order[d$family == "Ambystomatidae"] <- "Caudata"
d$order[d$family == "Craugastoridae"] <- "Anura"
d$order[d$family == "Dicroglossidae"] <- "Anura"
d$order[d$family == "Leptodactylidae"] <- "Anura"

unique(d$family[is.na(d$order)==TRUE])
d$order[d$family == "Hylodidae"] <- "Anura"
d$order[d$family == "Leiopelmatidae"] <- "Anura"
```

## *Reorganise columns*

### *Identify columns to homogeneise*
```{r}
# Identify columns present in the CTmax database, but not the CTmin/Tpref one
setdiff(colnames(CTmax_database), colnames(d))

# Identify columns present in the CTmin/Tpref database, but not the CTmax one
setdiff(colnames(d), colnames(CTmax_database))
```

### *Modify columns*
```{r}
# Rename columns in the CTmax database
CTmax_database <- CTmax_database %>% 
  dplyr::select(-es_ID, -study_ID, -species_ID, -row_n, 
                -screening_cat, # Unique identifiers for effect sizes, study, and species are not necessary
                -notes_species) %>% # Notes of species name changes are irrelevant in the data because further processing was done in the code above
  rename(notes_sampling = comment_sampling,
         mean_trait = mean_UTL, 
         error_trait = error_UTL, 
         n_trait = n_UTL) %>% 
  mutate(duration_measurement = NA, 
         rate_measurement = NA, 
         gradient_type = NA,
         gradient_low_temp = NA, 
         gradient_high_temp = NA)
  
  d <- d %>% 
  dplyr::select(-unique_ID, # IDs are not necessary as they will be updated
                -deg_min_sec_latitude, -deg_min_sec_longitude, # Remove latitudes and longitudes in DMS as they are irrelevant if we have decimal degrees
                -data_file_name, -fig_file_name, -notes_species) %>% 
    rename(peer_reviewed = `peer-reviewed`)

  
# Reformat some of the references
d$ref <- iconv(d$ref, from = "Windows-1252", to = "UTF-8") # Encoding to UTF-8
CTmax_database$ref <- iconv(CTmax_database$ref, from = "Windows-1252", to = "UTF-8")

# Manually check unique references in both datasets
table(d$ref)
#View(data.frame(unique(CTmax_database$ref))) 
#View(data.frame(unique(d$ref)))


d$ref[d$ref == "BalogovÃƒÆ’Ã‚Â¡_Gvozdik_2015"] <- "Balogova_and_Gvozdik_2015"
d$ref[d$ref == "Contreras-OÃƒÆ’Ã‚Â±ate_2016"] <- "Contreras-Onate_2016"
d$ref[d$ref == "ToufarovÃƒÂ¡_GvozdÃƒÂ­k_2016"] <- "Toufarova_and_Gvozdik_2016"

CTmax_database$ref[CTmax_database$ref == "Enriquez_Urzelai_et_al_2019"] <- "Enriquez-Urzelai_et_al_2019"
CTmax_database$ref[CTmax_database$ref == "Gutierrez-Pesquera_et_al_2016b"] <- "Gutierrez-Pesquera_2016"
CTmax_database$ref[CTmax_database$ref == "Gutiérrez-Pesquera_et_al_2016"] <- "Gutierrez-Pesquera_et_al_2016"
CTmax_database$ref[CTmax_database$ref == "Rivera_Ordonez_et_al_2019"] <- "Rivera-Ordonez_et_al_2019"
CTmax_database$ref[CTmax_database$ref == "Sanabria_et_al_2012"] <- "Sanabria_et_al_2012a"
CTmax_database$ref[CTmax_database$ref == "Arrigada-Garcia_2019"] <- "Arriagada-Garcia_2019"
CTmax_database$ref[CTmax_database$ref == "Sanabria_and_Quiroga_2010"] <- "Sanabria_and_Quiroga_2011a"

# Check again the references
#View(data.frame(unique(CTmax_database$ref)))
#View(data.frame(unique(d$ref)))
#View(data.frame(unique(setdiff(d$ref, CTmax_database$ref)))) # Seems ok

# Another check for references
d %>% group_by(ref) %>% summarise(n = n_distinct(title)) %>% filter(n>1) 

d$title[d$ref == "Sanabria_et_al_2012a"] <- "Seasonal changes in the thermal tolerances of the toad Rhinella arenarum (Bufonidae) in the Monte Desert of Argentina" # Fix copy-pasting issue

# Add publication year as a separate column
d <- d %>% 
  mutate(pub_year = as.integer(sub(".*_(\\d+)$", "\\1", ref))) 
# Correct publication year for studies from same authors on the same year
unique(filter(dplyr::select(d, ref, pub_year), is.na(pub_year)==TRUE))

d$pub_year[d$ref == "Layne_and_Claussen_1982a"] <- 1982
d$pub_year[d$ref == "Layne_and_Claussen_1982b"] <- 1982 
d$pub_year[d$ref == "Sanabria_et_al_2013a"] <- 2013 
d$pub_year[d$ref == "Sanabria_and_Quiroga_2011b"] <- 2011 
d$pub_year[d$ref == "Sanabria_and_Quiroga_2011c"] <- 2011 
d$pub_year[d$ref == "Sanabria_et_al_2013b"] <- 2013 
d$pub_year[d$ref == "Sanabria_et_al_2012a"] <- 2012 
d$pub_year[d$ref == "Sanabria_et_al_2012b"] <- 2012 
d$pub_year[d$ref == "Sanabria_and_Quiroga_2011a"] <- 2011

# Adjust the CTmax database slightly to make it comparable
d$metric[d$metric == "LT50"] <- "LT50_cold"
d$metric[d$metric == "PBT"] <- "Tpref" # Rename to Tpref
CTmax_database$metric[CTmax_database$metric == "LT50"] <- "LT50_hot" # Differentiate lower and upper limits for LT50

CTmax_database$flag[CTmax_database$n_trait == "1"] <- "Data from a single individual" # Flag observations with a sample size of 1

CTmax_database <- CTmax_database %>%
  mutate(life_stage_acclimated = case_when(
    is.na(incubation_temp) | is.na(acclimation_temp) ~ life_stage_acclimated,
    incubation_temp == acclimation_temp ~ "embryos_and_larvae",
    TRUE ~ life_stage_acclimated
  )) # Change acclimation values when acclimation temperatures overlap both the incubation and acclimated stage. 

CTmax_database <- CTmax_database %>%
  mutate(life_stage_tested = case_when(
    is.na(gosner_tested) ~ life_stage_tested,
    gosner_tested >= 45 ~ "juveniles",
    gosner_tested >= 42 & gosner_tested < 45 ~ "metamorphs",
    TRUE ~ life_stage_tested
  )) # Add a category for metamorphs

# Correct typo for the sex
d$sex[d$sex == "males"] <- "male"

# Add a value to each cohort ID to differentiate them from the 
d <- d %>%
    mutate(cohort_ID_numeric = paste0("co", as.numeric(gsub("co", "", cohort_ID)) + 3000))

```

### **Combine datasets**

```{r}
# Reorganise columns 
CTmin_Tpref_database <- dplyr::select(d,
    name,
    ref,
    title,
    pub_year,
    thesis_chapter,
    chapter_title,
    peer_reviewed,
    doi,
    language,
    population_ID,
    cohort_ID,
    notes_ID,
    order,
    family,
    species,
    strain,
    IUCN_status,
    origin,
    n_generations_lab,
    latitude,
    longitude,
    elevation,
    date_sampling,
    month_sampling,
    year_sampling,
    start_range_sampling_dates,
    end_range_sampling_dates,
    notes_sampling,
    ambient_temp,
    substrate_temp,
    water_temp,
    field_body_temp,
    notes_env_temp,
    acclimated,
    incubation_temp,
    sd_incubation_temp,
    life_stage_acclimated,
    gosner_acclimated,
    acclimation_temp,
    sd_acclimation_temp,
    acclimation_time,
    notes_acclimation,
    life_stage_tested,
    gosner_tested,
    SVL,
    body_mass,
    age_tested,
    sex,
    metric,
    endpoint,
    medium_test_temp,
    start_temp,
    ramping,
    set_time,
    n_test_temp,
    n_replicates_per_temp,
    n_animals_per_replicate,
    duration_measurement,
    rate_measurement,
    gradient_type,
    gradient_low_temp,
    gradient_high_temp,
    notes_test,
    humidity,
    oxygen,
    salinity,
    pH,
    photoperiod,
    chemical,
    hormone,
    concentration_chemical_hormone,
    unit_chemical_hormone,
    infected,
    pathogen,
    notes_supplements,
    data_source,
    data_url,
    flag,
    mean_trait,
    error_trait,
    n_trait,
    error_type,
    notes_trait = notes_UTL)

CTmax_database <- dplyr::select(CTmax_database,
    name,
    ref,
    title,
    pub_year,
    thesis_chapter,
    chapter_title,
    peer_reviewed,
    doi,
    language,
    population_ID,
    cohort_ID,
    notes_ID,
    order,
    family,
    species,
    strain,
    IUCN_status,
    origin,
    n_generations_lab,
    latitude,
    longitude,
    elevation,
    date_sampling,
    month_sampling,
    year_sampling,
    start_range_sampling_dates,
    end_range_sampling_dates,
    notes_sampling,
    ambient_temp,
    substrate_temp,
    water_temp,
    field_body_temp,
    notes_env_temp,
    acclimated,
    incubation_temp,
    sd_incubation_temp,
    life_stage_acclimated,
    gosner_acclimated,
    acclimation_temp,
    sd_acclimation_temp,
    acclimation_time,
    notes_acclimation,
    life_stage_tested,
    gosner_tested,
    SVL,
    body_mass,
    age_tested,
    sex,
    metric,
    endpoint,
    medium_test_temp,
    start_temp,
    ramping,
    set_time,
    n_test_temp,
    n_replicates_per_temp,
    n_animals_per_replicate,
    duration_measurement,
    rate_measurement,
    gradient_type,
    gradient_low_temp,
    gradient_high_temp,
    notes_test,
    humidity,
    oxygen,
    salinity,
    pH,
    photoperiod,
    chemical,
    hormone,
    concentration_chemical_hormone,
    unit_chemical_hormone,
    infected,
    pathogen,
    notes_supplements,
    data_source,
    data_url,
    flag,
    mean_trait,
    error_trait,
    n_trait,
    error_type,
    notes_trait = notes_UTL)

# Combine dataframes
Amphitherm <- rbind(CTmax_database, 
                  CTmin_Tpref_database)
```

### **Standardise common publications between datasets**

```{r}
Amphitherm %>% group_by(ref) %>% summarise(n = n_distinct(title)) %>% filter(n>1) 

Amphitherm$title[Amphitherm$ref == "Anderson_and_Andrade_2017"] <- "Trading heat and hops for water: Dehydration effects on locomotor performance, thermal limits, and thermoregulatory behavior of a terrestrial toad"
Amphitherm$title[Amphitherm$ref == "Bacigalupe_et_al_2018"] <- "Natural selection on plasticity of thermal traits in a highly seasonal environment"
Amphitherm$title[Amphitherm$ref == "Bonino_et_al_2020"] <- "Does temperature at local scale explain thermal biology patterns of
temperate tadpoles?"
Amphitherm$title[Amphitherm$ref == "Brattstrom_1968"] <- "Thermal acclimation in anuran amphibians as a function of latitude and altitude"
Amphitherm$title[Amphitherm$ref == "Burrowes_et_al_2020"] <- "Climatic Heterogeneity in the Bolivian Andes: Are Frogs Trapped?"
Amphitherm$title[Amphitherm$ref == "Castro_2019"] <- "Influence of environment on thermal ecology of direct-developing frogs (Anura: craugastoridae: pristimantis) in the eastern Andes of Colombia"
Amphitherm$title[Amphitherm$ref == "Davies_et_al_2015"] <- "Plasticity of thermal tolerance and metabolism but not water loss in an invasive reed frog"
Amphitherm$title[Amphitherm$ref == "Enriquez-Urzelai_et_al_2019"] <- "Ontogenetic reduction in thermal tolerance is not alleviated by earlier developmental acclimation in Rana temporaria"
Amphitherm$title[Amphitherm$ref == "Floyd_1983"] <- "Ontogenetic change in the temperature tolerance of larval Bufo marinus (Anura: Bufonidae)"
Amphitherm$title[Amphitherm$ref == "Floyd_1985"] <- "Effects of Photoperiod and starvation on the temperature tolerance of larvae of the giant toad, Bufo marinus"
Amphitherm$title[Amphitherm$ref == "Hou_2003"] <- "Long-term ecological research in Nanjenshan forest: Thermal tolerance and preference in the adult amphibians from different altitudinal LTER sites"
Amphitherm$title[Amphitherm$ref == "Kurabayashi_et_al_2014"] <- "Improved transport of the model amphibian, Xenopus tropicalis, and its viable temperature for transport"
Amphitherm$title[Amphitherm$ref == "Lotshaw_1977"] <- "Temperature Adaptation and Effects of Thermal Acclimation in Rana Sylvatica and Rana Catesbeiana"
Amphitherm$title[Amphitherm$ref == "Lu_et_al_2016"] <- "Swimming performance and thermal resistance of juvenile and adult newts acclimated to different temperatures"
Amphitherm$title[Amphitherm$ref == "Lu_et_al_2017"] <- "Physiological response and changes in swimming peprformance after thermal acclimation in juveniles chinese fire-belly newts, Cynops orientalis"
Amphitherm$title[Amphitherm$ref == "Manis_and_Claussen_1986"] <- "Environmental and genetic influences on the thermal physiology of Rana sylvatica"
Amphitherm$title[Amphitherm$ref == "Marshall_and_Grigg_1980"] <- "Environmental and genetic influences on the thermal physiology of Rana sylvatica"
Amphitherm$title[Amphitherm$ref == "Novarro_2018"] <- "Thermal physiology in a widespread lungless salamander"
Amphitherm$title[Amphitherm$ref == "Percino-Daniel_et_al_2021"] <- "Environmental heterogeneity shapes physiological traits in tropical direct-developing frogs"
Amphitherm$title[Amphitherm$ref == "Perotti_et_al_2018"] <- "How sensitive are temperate tadpoles to climate change? The use of thermal physiology and niche model tools to assess vulnerability"
Amphitherm$title[Amphitherm$ref == "Pintanel_et_al_2020"] <- "Critical Thermal Limits Do Not Vary between Wild-caught and Captive-bred Tadpoles of Agalychnis spurrelli (Anura: Hylidae)"
Amphitherm$title[Amphitherm$ref == "Pintanel_et_al_2021"] <- "Predators like it hot: Thermal mismatch in a predator–prey system across an elevational tropical gradient"
Amphitherm$title[Amphitherm$ref == "Quiroga_et_al_2019"] <- "Sublethal concentrations of chlorpyrifos induce changes in the thermal sensitivity and tolerance of anuran tadpoles in the toad Rhinella arenarum"
Amphitherm$title[Amphitherm$ref == "Rausch_2007"] <- "The thermal ecology of the Red-spotted toad, Bufo punctatus, across life history"
Amphitherm$title[Amphitherm$ref == "Riquelme_et_al_2016"] <- "Thermal tolerance in the Andean toad Rhinella spinulosa (Anura: Bufonidae) at three sites located along a latitudinal gradient in Chile"
Amphitherm$title[Amphitherm$ref == "Rivera-Ordonez_et_al_2019"] <- "Thermal niche variation among individuals of the poison frog, Oophaga pumilio, in forest and converted habitats"
Amphitherm$title[Amphitherm$ref == "Ruthsatz_et_al_2018"] <- "Thyroid hormone levels and temperature during development alter thermal tolerance and energetics of Xenopus laevis larvae"
Amphitherm$title[Amphitherm$ref == "Ruthsatz_et_al_2020"] <- "Post-metamorphic carry-over effects of altered thyroid hormone level and developmental temperature: physiological plasticity and body condition at two life stages in Rana temporaria"
Amphitherm$title[Amphitherm$ref == "Sanabria_et_al_2013a"] <- "Seasonal Changes in the Thermal Tolerances of Odontophrynus occidentalis (Berg, 1896) (Anura: Cycloramphidae)"
Amphitherm$title[Amphitherm$ref == "Sanabria_et_al_2013b"] <- "Thermal parameters and locomotor performance in juvenile of Pleurodema nebulosum (Anura: Leptodactylidae) from the Monte Desert"
Amphitherm$title[Amphitherm$ref == "Sanabria_et_al_2018"] <- "Effect of salinity on locomotor performance and thermal extremes of metamorphic Andean Toads (Rhinella spinulosa) from Monte Desert, Argentina"
Amphitherm$title[Amphitherm$ref == "Sanabria_et_al_2021"] <- "Vulnerability to warming in a desert amphibian tadpole community: the role of interpopulational variation"
Amphitherm$title[Amphitherm$ref == "Sanabria_and_Quiroga_2011a"] <- "Thermal parameters changes in males of Rhinella arenarum (Anura:Bufonidae) related to reproductive periods"
Amphitherm$title[Amphitherm$ref == "Sanabria_and_Quiroga_2011b"] <- "Change in the thermal biology of tadpoles of Odontophrynus occidentalis from the Monte desert, Argentina: Responses to photoperiod"
Amphitherm$title[Amphitherm$ref == "Wang_and_Li_2007"] <- "Effect of Temperature on Incubation and Thermal Tolerance of the Chinese Forest Frog"
Amphitherm$title[Amphitherm$ref == "von-May_et_al_2019"] <- "Thermal physiological traits in tropical lowland amphibians: Vulnerability to climate warming and cooling"

# Correct additional typos
Amphitherm$ref[Amphitherm$ref == "Aponte_Gutierrez_2020"] <- "Aponte-Gutierrez_2020"
Amphitherm$title[Amphitherm$ref == "Aponte-Gutierrez_2020"] <- "Endurecimiento térmico en Pristimantis medemi (Anura: Craugastoridae), en coberturas boscosas del Municipio de Villavicencio (Meta)"
Amphitherm$ref[Amphitherm$ref == "Castro_and_Andres_2019"] <- "Bernal-Castro_2019"
Amphitherm$ref[Amphitherm$ref == "Castro_2019"] <- "Bernal-Castro_2019"
Amphitherm$title[Amphitherm$ref == "Bernal-Castro_2019"] <- "Influence of environment on thermal ecology of direct-developing frogs (Anura: craugastoridae: pristimantis) in the eastern Andes of Colombia"
Amphitherm$ref[Amphitherm$ref == "Anderson_et_al_2018"] <- "De-Oliveria-Anderson_et_al_2018"
Amphitherm$title[Amphitherm$ref == "De-Oliveria-Anderson_et_al_2018"] <- "Seasonal variation in the thermal biology of a terrestrial toad, Rhinella icterica (Bufonidae), from the Brazilian Atlantic Forest"
Amphitherm$ref[Amphitherm$ref == "Contreras-Oñate_2016"] <- "Contreras-Onate_2016"
Amphitherm$ref[Amphitherm$ref == "Rosero_2015"] <- "Lopez-Rosero_2015"
Amphitherm$title[Amphitherm$ref == "Lopez-Rosero_2015"] <- "Ontogenetic variation of thermal tolerance in two anuran species of Ecuador: Gastrotheca pseustes (Hemiphractidae) and Smilisca phaeota (Hylidae) and their relative vulnerability to environmental temperature change"
Amphitherm$ref[Amphitherm$ref == "Fontenot_et_al_2011"] <- "Fontenot_and_Lutterschmidt_2011"
Amphitherm$ref[Amphitherm$ref == "Friedenberg_et_al_2004"] <- "Friedenberg_and_Skelly_2004"
Amphitherm$ref[Amphitherm$ref == "Gatten_et_al_1984"] <- "Gatten_and_Hill_1984"
Amphitherm$ref[Amphitherm$ref == "Guevera-Molina_et_al_2020"] <- "Guevara-Molina_et_al_2020"
Amphitherm$ref[Amphitherm$ref == "Jara-Mendez_2020"] <- "Jara-Mendez_et_al_2020"
Amphitherm$peer_reviewed[Amphitherm$ref == "Lange_2019"] <- "not_peer-reviewed"
Amphitherm$ref[Amphitherm$ref == "Krakauer_1969"] <- "Krakauer_1970"
Amphitherm$title[Amphitherm$ref == "Krakauer_1970"] <- "Tolerance limits of the toad, Bufo marinus, in South Florida"
Amphitherm$title[Amphitherm$ref == "Marshall_and_Grigg_1980"] <- "Acclimation of CTM, LD50, and rapid loss of acclimation of thermal preferendum in tadpoles of Limnodynastes peronii (Anura, Myobatrachidae)"
Amphitherm$ref[Amphitherm$ref == "Merino-Veteri_2018"] <- "Merino-Viteri_2018"
Amphitherm$ref[Amphitherm$ref == "Mullens_et_al_1992"] <- "Mullens_and_Hutchison_1992"
Amphitherm$ref[Amphitherm$ref == "Oymaguchi_et_al_2018"] <- "Oyamaguchi_et_al_2018"
Amphitherm$title[Amphitherm$ref == "Oyamaguchi_et_al_2018"] <- "Thermal sensitivity of a Neotropical amphibian (Engystomops pustulosus) and its vulnerability to climate change"
Amphitherm$ref[Amphitherm$ref == "Rocha_et_al_1998"] <- "Rocha_and_Branco_1998"
Amphitherm$ref[Amphitherm$ref == "Sanabria_and_Quiroga_2011c"] <- "Sanabria_et_al_2011"
Amphitherm$ref[Amphitherm$ref == "Sanabria_and_Quiroga_2011"] <- "Sanabria_and_Quiroga_2011b"
Amphitherm$title[Amphitherm$ref == "Sanabria_and_Quiroga_2011b"] <- "Change in the thermal biology of tadpoles of Odontophrynus occidentalis from the Monte desert, Argentina: Responses to photoperiod"
Amphitherm$ref[Amphitherm$ref == "Spotila_1971"] <- "Spotila_1972"
Amphitherm$title[Amphitherm$ref == "Spotila_1972"] <- "Role of temperature and water in the ecology of lungless salamanders"
Amphitherm$ref[Amphitherm$ref == "Williams_et_al_1993"] <- "Williams_and_Wygoda_1993"
Amphitherm$ref[Amphitherm$ref == "Wu_2019"] <- "Wu_2021"

# Correct typologies in publication year
Amphitherm$pub_year[Amphitherm$ref == "Young_and_Gifford_2013"] <- 2013 
Amphitherm$pub_year[Amphitherm$ref == "Sanabria_and_Quiroga_2011a"] <- 2011 
Amphitherm$pub_year[Amphitherm$ref == "Spotila_1972"] <- 1972 
Amphitherm$pub_year[Amphitherm$ref == "Wu_2021"] <- 2021 
Amphitherm$pub_year[Amphitherm$ref == "Krakauer_1970"] <- 1970

# Correct typologies in family classification 
Amphitherm %>% group_by(species) %>% summarise(n = n_distinct(family)) %>% filter(n>1) 

Amphitherm$family[Amphitherm$species == "Philoria loveridgei"] <- "Myobatrachidae"
Amphitherm$family[Amphitherm$species == "Proceratophrys schirchi"] <- "Odontophrynidae"
Amphitherm$family[Amphitherm$species == "Smilisca phaeota"] <- "Hylidae"

# Correct changes in IUCN threat status
Amphitherm %>% group_by(species) %>% summarise(n = n_distinct(IUCN_status)) %>% filter(n>1) 

Amphitherm$IUCN_status[Amphitherm$species=="Amazophrynella javierbustamantei"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Chiasmocleis royi"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Cophixalus australis"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Elachistocleis muiraquitan"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Epipedobates darwinwallacei"] <- "EN"
Amphitherm$IUCN_status[Amphitherm$species=="Hyloxalus yasuni"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Hypsiboas almendarizae"] <- "NT"
Amphitherm$IUCN_status[Amphitherm$species=="Plethodon chlorobryonis"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Plethodon grobmani"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Plethodon ocmulgee"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Plethodon variolatus"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Polypedates braueri"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Pristimantis bicantus"] <- "VU"
Amphitherm$IUCN_status[Amphitherm$species=="Pristimantis matidiktyo"] <- "CR"
Amphitherm$IUCN_status[Amphitherm$species=="Pristimantis reichlei"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Scinax strigilatus"] <- "LC"
Amphitherm$IUCN_status[Amphitherm$species=="Scinax tsachila"] <- "LC"

# Add unique identifier to each row
Amphitherm <- Amphitherm %>% mutate(row_ID = row_number()) %>% 
  dplyr::select(row_ID, everything())

# Standardize DOI values
Amphitherm <- Amphitherm %>%
  group_by(ref) %>%
  mutate(doi = first(doi)) %>%
  ungroup()

# Replace meantions of heat tolerance (HT) to "trait"
Amphitherm$notes_trait <- str_replace_all(Amphitherm$notes_trait, 
                                          c("sd_HT" = "sd_trait", 
                                            "n_HT" = "n_trait", 
                                            "mean_HT" = "mean_trait"))

# Assign coordinates that were missed during the previous data extraction
ctmax_na <- Amphitherm %>%
  filter(is.na(latitude) & metric == "CTmax") # Identify data with NA coordinates for CTmax
other_metrics_non_na <- Amphitherm %>%
  filter(!is.na(latitude) & metric != "CTmax") # Data for which we have coordinates for other metrics
refs <- intersect(ctmax_na$ref, other_metrics_non_na$ref) # References that intersect
subset_to_check_coordinates <- Amphitherm %>%
  filter(ref %in% refs) # Subset with coordinates to check


check <- dplyr::select(subset_to_check_coordinates, ref, species, population_ID, origin, latitude, longitude, metric, data_source)
#View(check %>% 
       #group_by(ref, species, origin) %>% 
       #summarise(n_coord = n_distinct(latitude, na.rm=T)))

# Add coordinates to species with missing coordinates, when there are only a single 
coord_summary <- check %>%
  group_by(ref, species, origin) %>%
  summarise(
    n_lat = n_distinct(latitude, na.rm = TRUE),
    n_long = n_distinct(longitude, na.rm = TRUE),
    unique_lat = ifelse(n_lat == 1, first(latitude[!is.na(latitude)]), NA_real_),
    unique_long = ifelse(n_long == 1, first(longitude[!is.na(longitude)]), NA_real_)
  ) %>%
  filter(n_lat == 1 & n_long == 1) # Keep only groups with exactly one unique latitude and longitude

Amphitherm <- Amphitherm %>%
  left_join(coord_summary, by = c("ref", "species", "origin")) %>%
  mutate(
    latitude = ifelse(is.na(latitude) & metric == "CTmax", unique_lat, latitude),
    longitude = ifelse(is.na(longitude) & metric == "CTmax", unique_long, longitude)
    # Similarly update elevation if needed
  ) %>%
  dplyr::select(-c(unique_lat, unique_long, n_lat, n_long))

# Check manually the other ones. 
ctmax_na <- Amphitherm %>%
  filter(is.na(latitude) & metric == "CTmax") # Identify data with NA coordinates for CTmax
other_metrics_non_na <- Amphitherm %>%
  filter(!is.na(latitude) & metric != "CTmax") # Data for which we have coordinates for other metrics
refs <- intersect(ctmax_na$ref, other_metrics_non_na$ref) # References that intersect
subset_to_check_coordinates <- Amphitherm %>%
  filter(ref %in% refs) %>% # Subset with coordinates to check 
  group_by(ref, species) %>% 
  dplyr::select(row_ID, ref, species, population_ID, origin, latitude, longitude, elevation, notes_sampling, metric, data_source)
subset_to_check_coordinates <- subset_to_check_coordinates %>% 
  group_by(ref, species, origin, latitude, longitude) %>% 
  summarise(n_coord = n_distinct(latitude))

# Homogeneise latitudes and longitudes
Amphitherm$latitude[Amphitherm$population_ID=="pop818"] <- 23.43733
Amphitherm$longitude[Amphitherm$population_ID=="pop818"] <- 120.7623
Amphitherm$latitude[Amphitherm$population_ID=="pop819"] <- 21.94878
Amphitherm$longitude[Amphitherm$population_ID=="pop819"] <- 120.7806

Amphitherm$latitude[Amphitherm$population_ID=="pop933"] <- 41.59854
Amphitherm$longitude[Amphitherm$population_ID=="pop933"] <- -74.79196
Amphitherm$latitude[Amphitherm$population_ID=="pop934"] <- 41.10655
Amphitherm$longitude[Amphitherm$population_ID=="pop935"] <- -78.89363
Amphitherm$latitude[Amphitherm$population_ID=="pop934"] <- 36.90270
Amphitherm$longitude[Amphitherm$population_ID=="pop935"] <- -81.89588
```

### **Check for duplicated data**
```{r}
# Round the trait values and coordinates to 2 decimal places
Amphitherm$mean_trait_rounded <- round(Amphitherm$mean_trait, 2)
Amphitherm$error_trait_rounded <- round(Amphitherm$error_trait, 2)
Amphitherm$latitude_rounded <- round(Amphitherm$latitude, 1)
Amphitherm$longitude_rounded <- round(Amphitherm$longitude, 1)
Amphitherm$elevation_rounded <- round(Amphitherm$elevation, -2)

# Identify duplicate rows measured in the same species, life stage, and using the same methods (e.g., acclimation_temp, endpoint)
duplicates <- Amphitherm[duplicated(Amphitherm[, c("species", "latitude_rounded", "longitude_rounded", "elevation_rounded", 
                                                   "life_stage_tested", "acclimation_temp", "endpoint",
                                                   "mean_trait_rounded", "error_trait_rounded")]) | 
                         duplicated(Amphitherm[, c("species", "latitude_rounded", "longitude_rounded", "elevation_rounded",
                                                   "life_stage_tested", "acclimation_temp", "endpoint",
                                                   "mean_trait_rounded", "error_trait_rounded")], fromLast = TRUE), ]
# Sort the dataset for comparison
duplicates <- duplicates[order(duplicates$species, duplicates$latitude_rounded, duplicates$longitude_rounded, duplicates$elevation_rounded,
                               duplicates$life_stage_tested, duplicates$ramping, 
                               duplicates$mean_trait_rounded, duplicates$error_trait_rounded), ]


#View(dplyr::select(duplicates, row_ID, name, ref, thesis_chapter, population_ID, cohort_ID, species, latitude, longitude, elevation, mean_trait, error_trait, n_trait, data_source, notes_trait)) # Visualise 

# Edit the Amphitherm dataset, removing duplicated observations
Amphitherm <- filter(Amphitherm, # Keep the published data instead of the thesis data
                     !(row_ID %in% c(3596, 3597, 2770, 2784, 2793, 2795, 2796, 2757, 2809, 2968, 2823,
                                     2912, 2914, 2910, 2908, 2905, 4447, 3789, 899, 900, 4525, 4526, 
                                     898, 897, 895, 896, 4522, 4524, 4521, 4525, 4526, 4523,
                                     4462, 4461, 4449, 4464, 4456, 4460, 4453, 4468, 4444, 2883))) # Only the observations that can reliably be identified as duplicates were removed. However, note that additional duplicates may be present, for instance, if coordinates were rounded or not presented clearly in the papers for each population. 
```



### **Create unique identifiers for each observation**

```{r}
Amphitherm <- Amphitherm %>% 
  arrange(ref, thesis_chapter, metric)

# Correcting populations that may be the same across studies. If the coordinates are the same across studies for the same species, the same population_ID will be assigned. However, if there are no coordinates, the original structure of the population_ID is maintained, and populations are assumed to be different across studies. 
Amphitherm <- Amphitherm %>%
  group_by(species, latitude_rounded, longitude_rounded, elevation_rounded) %>%
  mutate(new_pop_ID = cur_group_id()) %>%
  ungroup() %>%
  group_by(species) %>%
  mutate(new_pop_ID = dense_rank(new_pop_ID)) %>%
  ungroup()

head(dplyr::select(Amphitherm, species, population_ID, new_pop_ID, latitude, longitude))

# Get the maximum population for species with coordinates (to adjust those without coordinates)
max_pop_species <- Amphitherm %>%
  filter(!is.na(latitude_rounded)) %>%
  group_by(species) %>%
  summarise(max_pop = max(new_pop_ID, na.rm = TRUE), .groups = "drop")

# Adjust population IDs for species without coordinates
Amphitherm <- Amphitherm %>%
  mutate(pop_numeric = as.numeric(gsub("pop", "", population_ID))) %>%
  replace_na(list(pop_numeric = 0)) %>%
  left_join(max_pop_species, by = "species") %>%
  replace_na(list(max_pop = 0)) %>%
  group_by(species) %>%
  mutate(
    new_pop_ID_NA = ifelse(
      is.na(latitude_rounded),
      max_pop + dense_rank(paste0(ref, "_", pop_numeric)),  # unique numbering per study
      NA
    )
  ) %>%
  ungroup()

# Merge population IDs
Amphitherm <- Amphitherm %>%
  mutate(
    new_pop_ID = ifelse(
      is.na(latitude_rounded),
      new_pop_ID_NA,  # Use newly assigned IDs for NA cases
      new_pop_ID  # Keep previous IDs for coordinate-based cases
    )
  ) %>%
  mutate(new_pop_ID = paste0("pop", new_pop_ID)) %>%
  dplyr::select(-new_pop_ID_NA, -pop_numeric, -max_pop)

# Clean columns
Amphitherm <- Amphitherm %>%
  mutate(species_with_underscore = gsub(" ", "_", species)) %>%
  mutate(population_ID = paste(species_with_underscore, new_pop_ID, sep="_")) %>%
  dplyr::select(-new_pop_ID, -species_with_underscore)

print(unique(dplyr::select(Amphitherm, species, population_ID, latitude, longitude)), n=20)

# Adjusting cohort IDs
# Because CTmin and Tpref data were not extracted with CTmax data simultaneously, and some observations are repeated within traits over time or using different endpoints, accounting for repeated measures across traits is different. Here, we assign a cohort ID within trait to account for repeated measures; but we strongly encourage future analyses to consider using robust variance estimators (or similar) to account for multiple traits that may have been measured on the same animals (although not reported by the authors).
Amphitherm <- Amphitherm %>% 
  mutate(metric_general = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL",
                  ifelse(metric == "Tpref", "PBT", metric))))

# Assign cohort IDs
Amphitherm <- Amphitherm %>%
  group_by(ref, species, population_ID, metric_general) %>%
  mutate(cohort_ID_numeric = dense_rank(cohort_ID)) %>%
  ungroup()

head(dplyr::select(Amphitherm, ref, species, population_ID, cohort_ID, cohort_ID_numeric))


Amphitherm <- Amphitherm  %>% 
  mutate(new_cohort_ID = paste0("co", cohort_ID_numeric)) %>% 
  mutate(cohort_ID = paste(population_ID, metric_general, new_cohort_ID, sep="_")) %>% 
  dplyr::select(-cohort_ID_numeric, -new_cohort_ID, -longitude_rounded, -latitude_rounded, -elevation_rounded, -mean_trait_rounded, -error_trait_rounded, -metric_general)

head(dplyr::select(Amphitherm, ref, species, population_ID, cohort_ID))

# Reorganise dataframe
Amphitherm <- Amphitherm %>% 
  arrange(ref, thesis_chapter, metric, population_ID, cohort_ID)

# Add unique identifier to each row
Amphitherm <- Amphitherm %>% mutate(unique_ID = row_number()) %>% 
  dplyr::select(unique_ID, everything(), -row_ID)

# Save cleaned up database
write_csv(Amphitherm, file=here("data/Cleaned_data_Amphitherm.csv"))

# Save the data for each metric
CTmin<- filter(Amphitherm, metric== "CTmin" | metric =="LT50_cold")

CTmax<- filter(Amphitherm, metric== "CTmax" | metric =="LT50_hot")

Tpref<- filter(Amphitherm, metric== "Tpref")
```

# *Descriptive statistics for the cleaned data* 

```{r}
n_distinct(Amphitherm$unique_ID) # 4899 estimates
n_distinct(Amphitherm$ref) # 324 studies
n_distinct(Amphitherm$species) # 659 species
n_distinct(Amphitherm$population_ID) # 1653 populations 
n_distinct(Amphitherm$cohort_ID) # 4042 cohorts
n_distinct(Amphitherm$family) # 38 families

Amphitherm %>% group_by(ref) %>% 
          summarise(n_sp = n_distinct(species),
                    n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID)) %>% 
          ungroup() %>% 
          summarise(`Number of species per study` = mean(n_sp),
                    `SD species per study` = sd(n_sp),
                    `Minimum number of species per study` = min(n_sp),
                    `Maximum number of species per study` = max(n_sp),
                    
                    `Number of populations per study` = mean(n_pop),
                    `SD populations per study` = sd(n_pop),
                    `Minimum number of populations per study` = min(n_pop),
                    `Maximum number of populations per study` = max(n_pop),
                    
                    `Number of estimates per study` = mean(n_es),
                    `SD estimates per study` = sd(n_es),
                    `Minimum number of estimates per study` = min(n_es),
                    `Maximum number of estimates per study` = max(n_es))
#  (4.05 +/- 9.19) species per study on average (range: 1-87)
#  (5.53 +/- 12.1) populations per study on average (range: 1-113)
#  (15.1 +/- 29.1) estimates per study on average (range: 1-262)


Amphitherm %>% group_by(species) %>% 
          summarise(n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID),
                    n_acc = n_distinct(acclimation_temp)) %>% 
          ungroup() %>% 
          summarise(`Number of populations per species` = mean(n_pop),
                    `SD populations per species` = sd(n_pop),
                    `Minimum number of populations per species` = min(n_pop),
                    `Maximum number of populations per species` = max(n_pop),
                    
                    `Number of estimates per species` = mean(n_es),
                    `SD estimates per species` = sd(n_es),
                    `Minimum number of estimates per species` = min(n_es),
                    `Maximum number of estimates per species` = max(n_es))
#  (2.51 +/- 3.29) populations per species on average (range: 1-47)
#  (7.43 +/- 19.5) estimates per species on average (range: 1-292)

# Number of studies, species, populations and estimates for by metric (including LT50)
Amphitherm %>% group_by(metric) %>% 
          summarise(n_st = n_distinct(ref),
                    n_sp = n_distinct(species),
                    n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID)) 

# Number of studies, species, populations and estimates for by metric
Amphitherm %>% 
  mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL",
                  ifelse(metric == "Tpref", "PBT", metric)))) %>% 
  group_by(metric) %>% 
          summarise(n_st = n_distinct(ref),
                    n_sp = n_distinct(species),
                    n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID)) 

# Number of species with all three thermal traits (UTL, LTL, PBT)
Amphitherm %>%
  mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL",
                  ifelse(metric == "Tpref", "PBT", metric)))) %>%
  group_by(species) %>%
  summarise(n_metrics = n_distinct(metric)) %>% 
  filter(n_metrics == 3) %>% nrow() # 59 species with all 3 traits

# Number of studies with all three thermal traits (UTL, LTL, PBT)
Amphitherm %>%
  mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL",
                  ifelse(metric == "Tpref", "PBT", metric)))) %>%
  group_by(ref) %>%
  summarise(n_metrics = n_distinct(metric)) %>% 
  filter(n_metrics == 3) %>% nrow() # 17 studies measured all 3 traits

# Number of species with all three thermal traits (UTL, LTL, PBT)
Amphitherm %>%
  mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL", metric))) %>%
  filter(metric %in% c("LTL", "UTL")) %>%
  group_by(species) %>%
  summarise(n_metrics = n_distinct(metric)) %>% 
  filter(n_metrics == 2) %>% nrow() # 276 species with breadth

# Number of studies with thermal tolerance breadth (UTL and LTL)
Amphitherm %>%
  mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL", metric))) %>%
  filter(metric %in% c("LTL", "UTL")) %>%
  group_by(ref) %>%
  summarise(n_metrics = n_distinct(metric)) %>% 
  filter(n_metrics == 2) %>% nrow() # 61 studies measured breadth

# Number of studies, species, populations and estimates for by publication language
Amphitherm %>% group_by(language) %>% 
          summarise(n_st = n_distinct(ref),
                    n_sp = n_distinct(species),
                    n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID)) 

# Number of studies, species, populations and estimates for by publication language
Amphitherm %>% group_by(IUCN_status) %>% 
          summarise(n_sp = n_distinct(species),
                    n_es = n_distinct(unique_ID)) 

# Number of estimates missing measures of dispersion. 
n_distinct(Amphitherm$unique_ID[is.na(Amphitherm$error_trait)==TRUE])  # 933/4899 = 19.05%
```


# *Descriptive statistics for update with CTmin and Tpref* 

```{r}
# Filter dataset
CTmin_Tpref <- filter(Amphitherm, metric == "CTmin" | metric == "LT50_cold" | metric == "Tpref")

n_distinct(CTmin_Tpref$unique_ID) # 1844 estimates
n_distinct(CTmin_Tpref$ref) # 184 studies
n_distinct(CTmin_Tpref$species) # 375 species
n_distinct(CTmin_Tpref$population_ID) # 658 populations 
n_distinct(CTmin_Tpref$cohort_ID) # 1172 cohorts
n_distinct(CTmin_Tpref$family) # 32 families

# Number of studies, species, populations and estimates for by metric (including LT50)
CTmin_Tpref %>% group_by(metric) %>% 
          summarise(n_st = n_distinct(ref),
                    n_sp = n_distinct(species),
                    n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID)) 


# Number of studies, species, populations and estimates for by metric
CTmin_Tpref %>% 
    mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                           ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL",
                                  ifelse(metric == "Tpref", "PBT", metric)))) %>% 
    group_by(metric) %>% 
    summarise(n_st = n_distinct(ref),
              n_sp = n_distinct(species),
              n_pop = n_distinct(population_ID),
              n_es = n_distinct(unique_ID)) 

# Number of studies, species, populations and estimates for by publication language
CTmin_Tpref %>% group_by(language) %>% 
          summarise(n_st = n_distinct(ref),
                    n_sp = n_distinct(species),
                    n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID)) 

n_distinct(CTmin_Tpref$unique_ID[is.na(CTmin_Tpref$error_trait)==TRUE]) # Number of estimates missing measures of dispersion. 933/4939 = 18.89%
```

# **Data curation**

## *Remove species not described at the species level*
```{r}
Amphitherm_curated <- filter(Amphitherm, species != "Anaxyrus mix (2 species)" & # Remove observations done on a pooled sample of species
                               species != "Triturus hybrid" & # Remove hybrid species
                               species != "Aplastodiscus sp" & # Remove observations for species not described at the species level
                               species != "Crossodactylus sp" & 
                               species != "Engystomops sp" & 
                               species != "Hyloscirtus sp" & 
                               !str_detect(species, "\\.")) # Other species with sp.
```

## *Remove extinct species*

Remove one extinct species: *Taudactylus diurnus* (2 estimates)
```{r}
Amphitherm_curated <- filter(Amphitherm_curated, IUCN_status!="EX") 
```

## *Remove animals exposed to hormones, chemicals, or infected* 

```{r}
Amphitherm_curated <- filter(Amphitherm_curated, is.na(concentration_chemical_hormone)==TRUE|concentration_chemical_hormone==0)

Amphitherm_curated <- filter(Amphitherm_curated, is.na(infected)==TRUE)
```

## *Remove data with procedural concerns* 

```{r}
Amphitherm_curated <- filter(Amphitherm_curated, is.na(flag)==TRUE)
```

## *Export data*

```{r}
write_csv(Amphitherm_curated, file=here("data/Cleaned_and_curated_data_Amphitherm.csv"))
```


# **Descriptive statistics for the curated data**

```{r}
n_distinct(Amphitherm_curated$unique_ID) # 4401 estimates
n_distinct(Amphitherm_curated$ref) # 309 studies
n_distinct(Amphitherm_curated$species) # 614 species
n_distinct(Amphitherm_curated$population_ID) # 1486 populations 
n_distinct(Amphitherm_curated$cohort_ID) # 3603 cohorts
n_distinct(Amphitherm_curated$family) # 37 families


Amphitherm_curated %>% group_by(ref) %>% 
          summarise(n_sp = n_distinct(species),
                    n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID)) %>% 
          ungroup() %>% 
          summarise(`Number of species per study` = mean(n_sp),
                    `SD species per study` = sd(n_sp),
                    `Minimum number of species per study` = min(n_sp),
                    `Maximum number of species per study` = max(n_sp),
                    
                    `Number of populations per study` = mean(n_pop),
                    `SD populations per study` = sd(n_pop),
                    `Minimum number of populations per study` = min(n_pop),
                    `Maximum number of populations per study` = max(n_pop),
                    
                    `Number of estimates per study` = mean(n_es),
                    `SD estimates per study` = sd(n_es),
                    `Minimum number of estimates per study` = min(n_es),
                    `Maximum number of estimates per study` = max(n_es))
#  (3.96 +/- 8.97) species per study on average (range: 1-85)
#  (5.04 +/- 10.06) populations per study on average (range : 1-94)
#  (14.4 +/- 28.9) estimates per study on average (range : 1-256)


Amphitherm_curated %>% group_by(species) %>% 
          summarise(n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID),
                    n_acc = n_distinct(acclimation_temp)) %>% 
          ungroup() %>% 
          summarise(`Number of populations per species` = mean(n_pop),
                    `SD populations per species` = sd(n_pop),
                    `Minimum number of populations per species` = min(n_pop),
                    `Maximum number of populations per species` = max(n_pop),
                    
                    `Number of estimates per species` = mean(n_es),
                    `SD estimates per species` = sd(n_es),
                    `Minimum number of estimates per species` = min(n_es),
                    `Maximum number of estimates per species` = max(n_es))
#  (2.17 +/- 2.56) populations per species on average (range: 1-31)
#  (7.23 +/- 17.6) estimates per species on average (range: 1-239)

# Number of studies, species, populations and estimates for by metric
Amphitherm_curated %>% group_by(metric) %>% 
          summarise(n_st = n_distinct(ref),
                    n_sp = n_distinct(species),
                    n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID)) 

# Number of species with all three thermal traits (UTL, LTL, PBT)
Amphitherm_curated %>%
  mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL",
                  ifelse(metric == "Tpref", "PBT", metric)))) %>%
  group_by(species) %>%
  summarise(n_metrics = n_distinct(metric)) %>% 
  filter(n_metrics == 3) %>% nrow() # 52 species with all 3 traits

# Number of studies with all three thermal traits (UTL, LTL, PBT)
Amphitherm_curated %>%
  mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL",
                  ifelse(metric == "Tpref", "PBT", metric)))) %>%
  group_by(ref) %>%
  summarise(n_metrics = n_distinct(metric)) %>% 
  filter(n_metrics == 3) %>% nrow() # 13 studies measured all 3 traits

# Number of species with all three thermal traits (UTL, LTL, PBT)
Amphitherm_curated %>%
  mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL", metric))) %>%
  filter(metric %in% c("LTL", "UTL")) %>%
  group_by(species) %>%
  summarise(n_metrics = n_distinct(metric)) %>% 
  filter(n_metrics == 2) %>% nrow() # 255 species with breadth

# Number of studies with thermal tolerance breadth (UTL and LTL)
Amphitherm_curated %>%
  mutate(metric = ifelse(metric %in% c("CTmin", "LT50_cold"), "LTL",
                  ifelse(metric %in% c("CTmax", "LT50_hot"), "UTL", metric))) %>%
  filter(metric %in% c("LTL", "UTL")) %>%
  group_by(ref) %>%
  summarise(n_metrics = n_distinct(metric)) %>% 
  filter(n_metrics == 2) %>% nrow() # 52 studies measured breadth

# Number of studies, species, populations and estimates for by publication language
Amphitherm_curated %>% group_by(language) %>% 
          summarise(n_st = n_distinct(ref),
                    n_sp = n_distinct(species),
                    n_pop = n_distinct(population_ID),
                    n_es = n_distinct(unique_ID)) 

# Number of species and estimates by IUCN threat status
Amphitherm_curated %>% group_by(IUCN_status) %>% 
          summarise(n_sp = n_distinct(species),
                    n_es = n_distinct(unique_ID)) 

# Number of estimates missing measures of dispersion. 
n_distinct(Amphitherm_curated$unique_ID[is.na(Amphitherm_curated$error_trait)==TRUE]) # 810/4441 = 18.2%
```


# **Package versions**
```{r}
sessionInfo()
```

